import requests
import json
import lxml
import sys
import os

#from ebay_rare_item_search.settings import BASE_DIR
#sys.path.append(os.path.join(BASE_DIR, 'ebay_api/modules'))
from ebay_api_calls import findItemsByProduct

def uniqueItemFilterByProductId(items):

    filtered_items = []
    
    best_offer_only = "true"
    item_filter = [
        {
            "name": "BestOfferOnly",
            "value": best_offer_only
        }
    ]

    page_number = "1"
    entries_per_page = "3"
    pagination_input = {
        "entriesPerPage": entries_per_page,
        "pageNumber"    : page_number
    }

    for item in items:
        product_id = item["productId"][0]["__value__"]
        #product_id = "53039031"
        #print("product id: {}".format(product_id))
        response = findItemsByProduct(product_id, itemFilter=item_filter, paginationInput=pagination_input)
        #print(response)
        data = json.loads(response.decode('utf-8'))

        total_entries = int(data['findItemsByProductResponse'][0]['paginationOutput'][0]['totalEntries'][0])
        print("total_entries: {}".format(total_entries))

        if total_entries == 1:
            filtered_items.append(item)
    
    return filtered_items


if __name__ == "__main__":
    
    items = uniqueItemFilterByProductId([{'itemId': '313742249885', 'title': 'Intel Core i5-11400 - 2.6 GHz 6-Core (BX8070811400) Processor', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['164'], 'categoryName': ['CPUs/Processors']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/9xAAAOSwB4VhSHrL/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Intel-Core-i5-11400-2-6-GHz-6-Core-BX8070811400-Processor-/313742249885', 'productId': [{'@type': 'ReferenceID', '__value__': '24047054962'}], 'autoPay': ['false'], 'postalCode': ['300**'], 'location': ['Marietta,GA,USA'], 'country': ['US'], 'shippingInfo': [{'shippingType': ['Calculated'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['false'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['3']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '170.0'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '170.0'}], 'sellingState': ['Active'], 'timeLeft': ['P29DT19H39M35S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-06T23:28:55.000Z'], 'endTime': ['2021-12-06T23:28:55.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['2']}], 'returnsAccepted': ['true'], 'condition': [{'conditionId': ['3000'], 'conditionDisplayName': ['Used']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '144278578769', 'title': 'Apple 1st Generation Pencil - White', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['176981'], 'categoryName': ['Styluses']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/w6EAAOSwobdhaz~k/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Apple-1st-Generation-Pencil-White-/144278578769', 'productId': [{'@type': 'ReferenceID', '__value__': '4048951412'}], 'autoPay': ['true'], 'postalCode': ['750**'], 'location': ['Coppell,TX,USA'], 'country': ['US'], 'shippingInfo': [{'shippingType': ['Calculated'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['false'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['3']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '50.0'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '50.0'}], 'sellingState': ['Active'], 'timeLeft': ['P28DT19H52M21S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-06T23:41:48.000Z'], 'endTime': ['2021-12-05T23:41:41.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['2']}], 'returnsAccepted': ['false'], 'condition': [{'conditionId': ['3000'], 'conditionDisplayName': ['Used']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '203687100868', 'title': 'NETGEAR AT&T Unite Pro 781S Wi-Fi Mobile Hotspot Fully Kitted Out (AT&T)', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['175710'], 'categoryName': ['Mobile Broadband Devices']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/Be8AAOSwsvFhWk11/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/NETGEAR-AT-T-Unite-Pro-781S-Wi-Fi-Mobile-Hotspot-Fully-Kitted-Out-AT-T-/203687100868', 'productId': [{'@type': 'ReferenceID', '__value__': '16011555200'}], 'autoPay': ['true'], 'postalCode': ['119**'], 'location': ['Ridge,NY,USA'], 'country': ['US'], 'shippingInfo': [{'shippingServiceCost': [{'@currencyId': 'USD', '__value__': '0.0'}], 'shippingType': ['Free'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['true'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['1']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '43.69'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '43.69'}], 'sellingState': ['Active'], 'timeLeft': ['P28DT17H4M18S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-05T20:53:38.000Z'], 'endTime': ['2021-12-05T20:53:38.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['3']}], 'returnsAccepted': ['true'], 'condition': [{'conditionId': ['1500'], 'conditionDisplayName': ['Open box']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['true']}, {'itemId': '185150296527', 'title': 'Amazon Kindle Oasis (9th Generation) 8GB, Wi-Fi, 7in - Graphite with Amazon', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['171485'], 'categoryName': ['Tablets & eBook Readers']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/nC4AAOSwbBphhztu/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Amazon-Kindle-Oasis-9th-Generation-8GB-Wi-Fi-7in-Graphite-Amazon-/185150296527', 'productId': [{'@type': 'ReferenceID', '__value__': '239166707'}], 'autoPay': ['true'], 'postalCode': ['144**'], 'location': ['Fairport,NY,USA'], 'country': ['US'], 'shippingInfo': [{'shippingType': ['Calculated'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['true'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['1']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '140.0'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '140.0'}], 'sellingState': ['Active'], 'timeLeft': ['P29DT22H48M34S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-07T02:37:54.000Z'], 'endTime': ['2021-12-07T02:37:54.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['1']}], 'returnsAccepted': ['true'], 'condition': [{'conditionId': ['3000'], 'conditionDisplayName': ['Used']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '255209818200', 'title': 'TN014 TN-014 A3VV130 Genuine Konica Minolta Toner For Pro 1250 1052', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['16204'], 'categoryName': ['Toner Cartridges']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/eAAAAOSwaXthgCPU/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/TN014-TN-014-A3VV130-Genuine-Konica-Minolta-Toner-Pro-1250-1052-/255209818200', 'productId': [{'@type': 'ReferenceID', '__value__': '1400797014'}], 'autoPay': ['true'], 'postalCode': ['640**'], 'location': ['Blue Springs,MO,USA'], 'country': ['US'], 'shippingInfo': [{'shippingType': ['Calculated'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['true'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['1']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '325.0'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '325.0'}], 'sellingState': ['Active'], 'timeLeft': ['P26DT8H19M39S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-03T12:08:59.000Z'], 'endTime': ['2021-12-03T12:08:59.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['2']}], 'returnsAccepted': ['false'], 'condition': [{'conditionId': ['1000'], 'conditionDisplayName': ['New']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '194224085439', 'title': 'Apple MLA22LL/A Magic Keyboard 2 - Silver', 'globalId': ['EBAY-US'], 'subtitle': ['ðŸ”¥EXCELLENT CONDITIONðŸ”¥'], 'primaryCategory': [{'categoryId': ['33963'], 'categoryName': ['Keyboards & Keypads']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/HfMAAOSw9ythbvar/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Apple-MLA22LL-A-Magic-Keyboard-2-Silver-/194224085439', 'productId': [{'@type': 'ReferenceID', '__value__': '25026719178'}], 'autoPay': ['true'], 'postalCode': ['334**'], 'location': ['Boca Raton,FL,USA'], 'country': ['US'], 'shippingInfo': [{'shippingServiceCost': [{'@currencyId': 'USD', '__value__': '0.0'}], 'shippingType': ['Free'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['true'], 'oneDayShippingAvailable': ['true'], 'handlingTime': ['0']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '59.99'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '59.99'}], 'sellingState': ['Active'], 'timeLeft': ['P24DT16H55M1S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-07-01T20:44:21.000Z'], 'endTime': ['2021-12-01T20:44:21.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['20']}], 'returnsAccepted': ['true'], 'condition': [{'conditionId': ['1500'], 'conditionDisplayName': ['Open box']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '284517792085', 'title': 'Glorious PC Gaming Race O- (GOMGWHITE1) Wired Mouse', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['23160'], 'categoryName': ['Mice, Trackballs & Touchpads']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/KJUAAOSwZnBhhWIp/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Glorious-PC-Gaming-Race-O-GOMGWHITE1-Wired-Mouse-/284517792085', 'productId': [{'@type': 'ReferenceID', '__value__': '19036322673'}], 'autoPay': ['true'], 'postalCode': ['112**'], 'location': ['Brooklyn,NY,USA'], 'country': ['US'], 'shippingInfo': [{'shippingType': ['Calculated'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['false'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['3']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '26.0'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '26.0'}], 'sellingState': ['Active'], 'timeLeft': ['P28DT13H7M52S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-06T16:57:14.000Z'], 'endTime': ['2021-12-05T16:57:12.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['1']}], 'returnsAccepted': ['false'], 'condition': [{'conditionId': ['3000'], 'conditionDisplayName': ['Used']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '353758072470', 'title': 'Windows 10 Home 32/64 Bit English USB Flash Drive New Sealed', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['11226'], 'categoryName': ['Operating Systems']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/zXMAAOSwAcBhhWci/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Windows-10-Home-32-64-Bit-English-USB-Flash-Drive-New-Sealed-/353758072470', 'productId': [{'@type': 'ReferenceID', '__value__': '245926133'}], 'autoPay': ['true'], 'postalCode': ['407**'], 'location': ['East Bernstadt,KY,USA'], 'country': ['US'], 'shippingInfo': [{'shippingServiceCost': [{'@currencyId': 'USD', '__value__': '0.0'}], 'shippingType': ['Free'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['false'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['3']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '42.0'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '42.0'}], 'sellingState': ['Active'], 'timeLeft': ['P28DT13H29M6S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-11-06T17:18:28.000Z'], 'endTime': ['2021-12-05T17:18:26.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['2']}], 'returnsAccepted': ['false'], 'condition': [{'conditionId': ['1000'], 'conditionDisplayName': ['Brand New']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}, {'itemId': '124916327813', 'title': 'Netgear Nighthawk C7000 AC1900 Dual-Band Built-in DOCSIS 3.0 Cable Modem Router', 'globalId': ['EBAY-US'], 'primaryCategory': [{'categoryId': ['44995'], 'categoryName': ['Wireless Routers']}], 'galleryURL': 'https://i.ebayimg.com/thumbs/images/g/P-gAAOSw8EVhTN66/s-l140.jpg', 'viewItemURL': 'https://www.ebay.com/itm/Netgear-Nighthawk-C7000-AC1900-Dual-Band-Built-in-DOCSIS-3-0-Cable-Modem-Router-/124916327813', 'productId': [{'@type': 'ReferenceID', '__value__': '222714264'}], 'autoPay': ['false'], 'postalCode': ['900**'], 'location': ['Los Angeles,CA,USA'], 'country': ['US'], 'shippingInfo': [{'shippingServiceCost': [{'@currencyId': 'USD', '__value__': '0.0'}], 'shippingType': ['Free'], 'shipToLocations': ['Worldwide'], 'expeditedShipping': ['false'], 'oneDayShippingAvailable': ['false'], 'handlingTime': ['1']}], 'sellingStatus': [{'currentPrice': [{'@currencyId': 'USD', '__value__': '109.99'}], 'convertedCurrentPrice': [{'@currencyId': 'USD', '__value__': '109.99'}], 'sellingState': ['Active'], 'timeLeft': ['P16DT16H24M5S']}], 'listingInfo': [{'bestOfferEnabled': ['true'], 'buyItNowAvailable': ['false'], 'startTime': ['2021-09-23T20:13:25.000Z'], 'endTime': ['2021-11-23T20:13:25.000Z'], 'listingType': ['FixedPrice'], 'gift': ['false'], 'watchCount': ['27']}], 'returnsAccepted': ['true'], 'condition': [{'conditionId': ['1500'], 'conditionDisplayName': ['Open box']}], 'isMultiVariationListing': ['false'], 'topRatedListing': ['false']}])

    #print(items)
    print(len(items))
